# CORSè·¨åŸŸ

## åŸºç¡€çŸ¥è¯†

### ä»€ä¹ˆæ˜¯è·¨åŸŸ

æ¯ä¸ªæœåŠ¡å™¨éƒ½æœ‰1ä¸ªå”¯ä¸€çš„åŸŸåï¼ŒåŸŸåç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š

â€‹           åè®®ã€åŸŸåã€ç«¯å£

â€‹           å¦‚ï¼šhttp:www.baidu.com:80

å½“åŸŸåä¸­å­˜åœ¨ä»»ä½•ä¸€éƒ¨åˆ†ä¸åŒæ—¶ï¼Œåˆ™è®¤ä¸ºæ˜¯è·¨åŸŸ

â€‹           å¦‚ï¼šæ¥è‡ª[www.baodu.com](http://www.baodu.com)çš„é¡µé¢è¦è¯·æ±‚[www.google.com](http://www.google.com)çš„èµ„æºï¼Œå°±æ˜¯è·¨åŸŸ

### æµè§ˆå™¨å¦‚ä½•è¿›è¡Œè·¨åŸŸé™åˆ¶

+ è·¨åŸŸé™åˆ¶ä»…é™äºajaxè¯·æ±‚

+ é»˜è®¤æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨ä»äº’è”ç½‘ä¸Šè¯·æ±‚ä¸‹æ¥çš„jsè„šæœ¬ï¼Œéƒ½ä¼šè®°ä½ä»–æ¥è‡ªå“ªä¸ªåŸŸåï¼Œå½“æŸä¸ªjsè„šæœ¬æƒ³è¦å‘é€ä¸ä»–çš„æ¥æºä¸åŒåŸŸçš„è¯·æ±‚æ—¶ï¼Œæµè§ˆå™¨ä¼šå…ˆåˆ¤æ–­è¿™æ˜¯1ä¸ªç®€å•è¯·æ±‚è¿˜æ˜¯éç®€å•è¯·æ±‚ï¼Œå¦‚æœè¿™æ˜¯1ä¸ªç®€å•è¯·æ±‚ï¼Œåˆ™ä¼šè‡ªåŠ¨æ·»åŠ 1ä¸ªoriginè¯·æ±‚å¤´ç›´æ¥å‘é€å‡ºå»ï¼›å¦‚æœæ˜¯éç®€å•è¯·æ±‚ï¼Œåˆ™ä¼šè‡ªåŠ¨æ·»åŠ ä¸€äº›è¯·æ±‚å¤´å…ˆé¢„æ£€ä¸€ä¸‹æœåŠ¡å™¨æ˜¯å¦å…è®¸å½“å‰åŸŸçš„è¯·æ±‚ï¼Œå¦‚æœæœåŠ¡å™¨å…è®¸ï¼Œåˆ™çœŸæ­£çš„å°†è¯·æ±‚å‘å‡ºå»ï¼Œå¦åˆ™å°±æŠ¥é”™ï¼ˆå‚è§[CORSè¯·æ±‚](#CORSè¯·æ±‚)ï¼‰

+ ä¸¾ä¸ªğŸŒ°ï¼š

  ç°åœ¨æµè§ˆå™¨ä¸Šè¿è¡Œçš„jsè„šæœ¬æ˜¯æ¥è‡ªAç½‘ç«™çš„ï¼Œä½†æ˜¯è¯¥é¡µé¢å‘Bç«™å‘é€äº†1ä¸ªajaxè¯·æ±‚ï¼Œæµè§ˆå™¨ä¸€çœ‹ï¼Œä½ è¿™æ˜¯è·¨åŸŸäº†ï¼Œå°±ä¼šå…ˆåˆ¤æ–­è¯¥è¯·æ±‚æ˜¯å¦å±äºç®€å•è¯·æ±‚ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è‡ªåŠ¨æ·»åŠ originè¯·æ±‚å¤´ç›´æ¥å°†è¯·æ±‚å‘å‡ºï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™å…ˆå‘ä¸€ä¸ªâ€œé¢„æ£€â€è¯·æ±‚ï¼Œå¦‚æœæµè§ˆå™¨å›å¤å…è®¸ä½ è®¿é—®ï¼Œåˆ™çœŸæ­£çš„å‘å‡ºè¯·æ±‚ï¼Œå¦åˆ™å°±ä¸è®©å‘äº†

### ä¸ºä»€ä¹ˆè¦è·¨åŸŸ

+ æœ‰çš„æ—¶å€™åŒä¸€ä¸ªå…¬å¸å¯èƒ½æœ‰å¥½å‡ ä¸ªå­åŸŸåï¼Œä»–ä»¬ä¹‹é—´éœ€è¦è·¨åŸŸäº’ç›¸è®¿é—®èµ„æº

+ å½“ä½ çš„é¡¹ç›®éœ€è¦ä½¿ç”¨ç™¾åº¦åœ°å›¾çš„apiæ—¶ï¼Œéœ€è¦è·¨åŸŸè®©æµè§ˆå™¨å…è®¸ä½ çš„é¡µé¢å‘é€å¯¹ç™¾åº¦åœ°å›¾æ‰€åœ¨çš„åŸŸåçš„è¯·æ±‚

## CORSè¯·æ±‚

+ æµè§ˆå™¨å°†CORSè¯·æ±‚åˆ†æˆä¸¤ç±»ï¼šç®€å•è¯·æ±‚ï¼ˆsimple requestï¼‰å’Œéç®€å•è¯·æ±‚ï¼ˆnot-so-simple requestï¼‰
+ åªè¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤å¤§æ¡ä»¶ï¼Œå°±å±äºç®€å•è¯·æ±‚
  + è¯·æ±‚æ–¹æ³•æ˜¯ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ä¹‹ä¸€ï¼š
    + HEAD
    + GET
    + POST
  + HTTPçš„å¤´ä¿¡æ¯ä¸è¶…å‡ºä»¥ä¸‹å‡ ç§å­—æ®µ
    + Accept
    +  Accept-Language
    + Content-Language
    + Last-Event-ID
    + Content-Typeï¼šåªé™äºä¸‰ä¸ªå€¼application/x-www-form-urlencodedã€multipart/form-dataã€text/plain
+ å…¶ä»–çš„éƒ½æ˜¯éç®€å•è¯·æ±‚

### ç®€å•è¯·æ±‚

+ ç®€å•è¯·æ±‚è¯·æ±‚å¤´

  å¯¹äºç®€å•è¯·æ±‚ï¼Œæµè§ˆå™¨è‡ªåŠ¨æ·»åŠ 1ä¸ª`Origin`è¯·æ±‚å¤´ï¼Œå¹¶å°†è¯·æ±‚ç›´æ¥å‘å‡º

  `Origin`ï¼šç”¨äºæ ‡è¯†è¯¥è·¨åŸŸè¯·æ±‚æ¥è‡ªå“ªä¸ªåŸŸå

  ä¾‹ï¼š`localhost:8001`ä¸­çš„`123.html`

  ```html
  <body>
      <div id="div1"></div>
  </body>
  </html>
  <script type="text/javascript">
      var url = 'http://localhost:8002';
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function(){
          if ((xhr.readyState == 4) && (xhr.status == 200)){
              document.getElementById('div1').innerHTML += xhr.responseText;
          }
      };
          xhr.onerror = function(){
          document.getElementById('div1').innerHTML += 'request error';
      };
      xhr.open('GET', url, true);
      xhr.send(null);
  </script>
  ```

  åˆ·æ–°123.htmlé¡µé¢å°±ä¼šå‘å‡ºcorsè¯·æ±‚ï¼Œåœ¨æ§åˆ¶å°çœ‹åˆ°è¯·æ±‚å¤´å¦‚ä¸‹ï¼š

  ![image-20190306120113146](assets/image-20190306120113146-1844873.png) 

+ ç®€å•è¯·æ±‚å“åº”å¤´

  + Access-Control-Allow-Origin

    æœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œæ ¹æ®è¯·æ±‚å¤´ä¸­`Origin`å­—æ®µå€¼åˆ¤æ–­æ˜¯å¦åŒæ„è¿™æ¬¡è¯·æ±‚ã€‚

    + å¦‚æœæœåŠ¡ç«¯è¿”å›`Access-Control-Allow-Origin`å¤´ï¼Œå¹¶ä¸”è¯¥å¤´çš„å€¼åŒ…å«è¯·æ±‚ä¸­`Origin`æŒ‡å®šçš„åŸŸåï¼Œåˆ™æµè§ˆå™¨è®¤ä¸ºæœåŠ¡ç«¯å…è®¸è¿™æ¬¡è·¨åŸŸè¯·æ±‚
    + å¦‚æœæœåŠ¡ç«¯æ²¡æœ‰è¿”å›`Access-Control-Allow-Origin`å¤´ï¼Œæˆ–è€…è¯¥å¤´çš„å€¼æ²¡æœ‰åŒ…å«è¯·æ±‚ä¸­`Origin`æŒ‡å®šçš„åŸŸåï¼Œåˆ™æµè§ˆå™¨è®¤ä¸ºæœåŠ¡ç«¯ä¸å…è®¸è¿™æ¬¡è·¨åŸŸè¯·æ±‚

  + Access-Control-Expose-Headers

    + è¯¥å­—æ®µæ˜¯å¯é€‰çš„

    + åŠŸèƒ½

      ç”¨äºæŒ‡å®šå“ªäº›å“åº”å¤´å¯ä»¥æš´éœ²ç»™æµè§ˆå™¨

    + è¯´æ˜

      â€‹        æµè§ˆå™¨æ¥æ”¶åˆ°è·¨åŸŸè¯·æ±‚çš„å“åº”å¤´æ—¶ï¼Œ`XMLHttpRequest`å¯¹è±¡çš„`getResponseHeader()`æ–¹æ³•åªèƒ½æ‹¿åˆ°6ä¸ªåŸºæœ¬å­—æ®µï¼š`Cache-Control`ã€`Content-Language`ã€`Content-Type`ã€`Expires`ã€`Last-Modified`ã€`Pragma`ï¼Œå…¶ä»–çš„å­—æ®µå³ä½¿è®¾ç½®åˆ°å“åº”å¤´ä¸­ï¼Œä¹Ÿæ— æ³•æ‹¿åˆ°è¿™ä¸ªå­—æ®µçš„å€¼

      â€‹        å¦‚æœæœåŠ¡å™¨å¸Œæœ›æµè§ˆå™¨ä¸­å¯ä»¥æ‹¿åˆ°å…¶ä»–å“åº”å¤´ï¼Œå°±å°†å…¶ä»–å“åº”å¤´ä»¥æ•°ç»„å½¢å¼è®¾ç½®ä¸º`Access-Control-Expose-Header`å­—æ®µçš„å€¼ï¼Œæµè§ˆå™¨å°±å¯ä»¥è·å–åˆ°è¿™äº›å­—æ®µçš„å€¼äº†

      ![image-20190306142533455](assets/image-20190306142533455-1853533.png) 


### éç®€å•è¯·æ±‚

+ éç®€å•è¯·æ±‚åœ¨æ­£å¼è¯·æ±‚ä¹‹å‰ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¢åŠ 1æ¬¡é¢„æ£€è¯·æ±‚ï¼Œæ¥è¯¢é—®æœåŠ¡å™¨å½“å‰ç½‘é¡µçš„åŸŸåæ˜¯å¦åœ¨æœåŠ¡å™¨çš„è®¸å¯åå•ä¸­ï¼Œä»¥åŠå¯ä»¥ä½¿ç”¨å“ªäº›è¯·æ±‚æ–¹å¼å’Œå¤´ä¿¡æ¯å­—æ®µï¼Œåªæœ‰å¾—åˆ°è‚¯å®šç­”å¤ï¼Œæµè§ˆå™¨æ‰æ­£å¼å‘é€çœŸæ­£çš„è¯·æ±‚ï¼Œå¦åˆ™æµè§ˆå™¨ç›´æ¥æŠ¥é”™ï¼Œä¸å†å‘é€æ­£å¼è¯·æ±‚

+ ä¾‹

  ```html
  <body>
      <div id="div1"></div>
  </body>
  </html>
  <script type="text/javascript">
      var url = 'http://localhost:8002/test';
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function(){
          if ((xhr.readyState == 4) && (xhr.status == 200)){
              document.getElementById('div1').innerHTML += xhr.responseText;
          }
      };
      xhr.onerror = function(){
          document.getElementById('div1').innerHTML += 'request error';
      };
      xhr.open('PUT', url, true);
      xhr.setRequestHeader('key1','value1');
      xhr.setRequestHeader('key2','value2');
      xhr.send(null);
  </script>
  ```

  åˆ·æ–°è¯¥é¡µé¢åï¼Œæ§åˆ¶å°å¯ä»¥çœ‹è§3æ¬¡è¯·æ±‚ï¼š

  ![image-20190306133353997](assets/image-20190306133353997-1850434.png) 

#### é¢„æ£€è¯·æ±‚

+ é¢„æ£€è¯·æ±‚é‡‡ç”¨`OPTION`è¯·æ±‚æ–¹å¼

+ é¢„æ£€è¯·æ±‚æµè§ˆå™¨è‡ªåŠ¨åœ¨è¯·æ±‚å¤´ä¸­åŠ å…¥å¦‚ä¸‹å­—æ®µ

  + Origin

    è¯·æ±‚è·¨åŸŸçš„åŸŸå

  + Access-Control-Request-Method

    è¯·æ±‚è·¨åŸŸçš„è¯·æ±‚æ–¹æ³•

  + Access-Control-Request-Headers

    è¯·æ±‚è·¨åŸŸçš„è¯·æ±‚ä¸­åŒ…å«å“ªäº›è¯·æ±‚å¤´

  ä¾‹ï¼š

  ![image-20190306140518941](assets/image-20190306140518941-1852319.png) 

+ é¢„æ£€è¯·æ±‚å“åº”å¤´

  å¦‚æœæœåŠ¡ç«¯æ²¡æœ‰å®ç°`CORS`æ”¯æŒï¼Œåˆ™ä¸ä¼šè¿”å›ä»»ä½•`cors`ç›¸å…³å¤´ä¿¡æ¯ï¼Œæµè§ˆå™¨åŒæ ·è®¤ä¸ºæœåŠ¡ç«¯ä¸æ”¯æŒè·¨åŸŸ

  å¦‚æœæœåŠ¡ç«¯å®ç°äº†`CORS`æ”¯æŒï¼Œåˆ™ç›¸åº”å¤´ä¿¡æ¯å¦‚ä¸‹ï¼š

  + å¿…é¡»åŒ…å«å“åº”å¤´

    + Access_Control_Allow_Origin

      å¦‚æœæ²¡æœ‰è¯¥å¤´ï¼Œæˆ–è¯¥å¤´çš„å€¼ä¸æ˜¯è¯·æ±‚è·¨åŸŸçš„åŸŸåï¼Œæˆ–è¯¥å¤´çš„å€¼ä¸æ˜¯`*`ï¼Œè¡¨ç¤ºæœåŠ¡å™¨æ‹’ç»

    + Access_Control_Allow_Methods

      å¦‚æœè¯¥å¤´ä¸­å…è®¸çš„è¯·æ±‚æ–¹å¼ä¸åŒ…æ‹¬å½“å‰è¯·æ±‚çš„è¯·æ±‚æ–¹å¼ï¼Œåˆ™æµè§ˆå™¨è®¤ä¸ºæœåŠ¡å™¨æ‹’ç»

    + Access_Control_Allow_Headers

      å¦‚æœè¯¥å¤´ä¸­æ²¡æœ‰å…¨éƒ¨åŒ…å«`Access-Control-Request-Headers`ä¸­æŒ‡å®šçš„å¤´ï¼Œåˆ™è®¤ä¸ºæœåŠ¡å™¨æ‹’ç»

  + å¯èƒ½åŒ…å«å“åº”å¤´

    +  Access_Control_Allow_Credentials

      æ ‡è¯†æ˜¯å¦å…è®¸å‘é€`cookie`ï¼Œå¦‚æœå…è®¸ï¼Œè®¾ç½®è¯¥å­—æ®µä¸º`true`ï¼›å¦‚æœä¸å…è®¸ï¼Œä¸ä½¿ç”¨è¯¥å­—æ®µå³å¯

    + Access-Control-Max-Age

      ç”¨æ¥æŒ‡å®šæœ¬æ¬¡é¢„æ£€è¯·æ±‚æœ‰æ•ˆæœŸï¼Œå•ä½ç§’ï¼Œåœ¨æ­¤æœŸé—´ï¼Œä¸ç”¨å‘å‡ºå¦ä¸€æ¡é¢„æ£€è¯·æ±‚

      å¦‚æœä¸ä½¿ç”¨è¯¥å‚æ•°ï¼Œé»˜è®¤5så†…ä¸éœ€è¦é¢„æ£€

  ä¾‹ï¼š

  ![image-20190306140613944](assets/image-20190306140613944-1852374.png) 

#### æ­£å¼è¯·æ±‚

ä¸€æ—¦æœåŠ¡å™¨é€šè¿‡äº†`é¢„æ£€è¯·æ±‚`ï¼Œæµè§ˆå™¨å‘é€çš„`æ­£å¼è¯·æ±‚`ï¼Œå°±éƒ½è·Ÿ`ç®€å•è¯·æ±‚`ä¸€æ ·äº†

## springbooté…ç½®è·¨åŸŸ

### æ³¨è§£æ–¹å¼

+ ä½¿ç”¨`@CrossOrigin`æ³¨è§£é…ç½®è·¨åŸŸï¼Œè¯¥æ³¨è§£è¯´æ˜å‚è§[@CrossOrigin](https://github.com/Mshuyan/springMVC/blob/master/demo01-annotation/springMVC%E6%B3%A8%E8%A7%A3%E7%AF%87.md#crossorigin) 

+ è¯¥æ³¨è§£åªèƒ½æ”¯æŒæ¥å£çº§åˆ«çš„è·¨åŸŸ

+ ä¾‹

  ```java
  @RequestMapping("/test")
  @CrossOrigin(value = {"localhost"})
  public String test(){
      return "ok";
  }
  ```

### é‡å†™MVCé…ç½®ç±»æ–¹æ³•

è¯¥æ–¹å¼æ˜¯å…¨å±€è·¨åŸŸæ–¹å¼

```java
@Configuration
public class CorsConfig extends WebMvcConfigurationSupport {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        // æ ¹æ® url ç»å¯¹å¯¹å“ªäº›æ¥å£æä¾›è·¨åŸŸæ”¯æŒ
        registry.addMapping("/**")
                .allowedOrigins("http://localhost")
                .allowedMethods("*")
                .allowedHeaders("*");
    }
}
```

### è¿‡æ»¤å™¨1

å…¨å±€è·¨åŸŸæ–¹å¼

```java
@Bean
public FilterRegistrationBean corsFilter() {
    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    CorsConfiguration config = new CorsConfiguration();
    config.setAllowCredentials(false);
    // è®¾ç½®ä½ è¦å…è®¸çš„ç½‘ç«™åŸŸåï¼Œå¦‚æœå…¨å…è®¸åˆ™è®¾ä¸º *
    config.addAllowedOrigin("*");
    // å¦‚æœè¦é™åˆ¶ HEADER æˆ– METHOD è¯·è‡ªè¡Œæ›´æ”¹
    config.addAllowedHeader("*");
    config.addAllowedMethod("*");
    config.addExposedHeader("Content-Disposition");
    source.registerCorsConfiguration("/**", config);
    return new FilterRegistrationBean<>(new CorsFilter(source));
}
```

### è¿‡æ»¤å™¨2

```java
@Bean
public CorsFilter corsFilter() {
    CorsConfiguration config = new CorsConfiguration();
    config.addAllowedOrigin("http://localhost");
    config.setAllowCredentials(true);
    config.addAllowedMethod("*");
    config.addAllowedHeader("*");
    UrlBasedCorsConfigurationSource configSource = new UrlBasedCorsConfigurationSource();
    configSource.registerCorsConfiguration("/**", config);
    return new CorsFilter(configSource);
}
```

### security

+ å…¨å±€è·¨åŸŸæ–¹å¼
+ ä½¿ç”¨`security`ä¹‹åï¼Œå› ä¸º`login`æ¥å£æ˜¯ç”±`security`æä¾›çš„ï¼Œæ‰€ä»¥ä¸Šè¿°æ–¹æ³•æ— æ³•å¯¹`login`æ¥å£æä¾›è·¨åŸŸæ”¯æŒï¼Œæ­¤æ—¶éœ€è¦ä½¿ç”¨`security`æä¾›çš„è·¨åŸŸæ–¹æ³•

+ å®ç°æ–¹å¼å‚è§[security-cors](https://github.com/Mshuyan/security/blob/master/spring4all/README.md#cors) 

## åŒæº

+ åœ¨ä¸€æ¬¡è¯·æ±‚ä¸­ï¼Œå¦‚æœ`Host`ä¸`Origin`è¯·æ±‚å¤´ç›¸åŒï¼Œåˆ™è®¤ä¸ºè¯¥è¯·æ±‚æ˜¯1ä¸ªåŒæºè¯·æ±‚
+ å¯¹äºåŒæºè¯·æ±‚ï¼ŒæœåŠ¡ç«¯ä¸ä¼šè¿”å›`cors`ç›¸å…³å“åº”å¤´
+ å‚è§`org.springframework.web.util.isSameOrigin`æ–¹æ³•

## é‡‡å‘è®°å½•

### nginxä»£ç†å¯¼è‡´åŒæºè¯·æ±‚

å‚è§[security-cors-é‡‡å‘è®°å½•](https://github.com/Mshuyan/security/blob/master/spring4all/README.md#é‡‡å‘è®°å½•)  